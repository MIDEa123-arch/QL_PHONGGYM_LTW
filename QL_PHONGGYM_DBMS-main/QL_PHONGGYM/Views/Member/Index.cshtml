@model QL_PHONGGYM.Models.KhachHang
@{
    ViewBag.Title = "Tổng quan";
    Layout = "~/Views/Shared/_LayoutMember.cshtml";

    var kh = Session["KhachHang"] as QL_PHONGGYM.Models.KhachHang;
    var activePackages = ViewBag.GoiTapHienTai as List<QL_PHONGGYM.Models.DangKyGoiTap>;
    var recentOrders = ViewBag.RecentOrders as List<QL_PHONGGYM.Models.HoaDon>;
    decimal tongTien = ViewBag.TongTienTichLuy;
    int soDon = ViewBag.SoDonHang;
}

<div class="bg-white rounded-3 shadow-sm p-4 mb-3">
    <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <div class="position-relative">
                <img src="~/Content/Images/user.png" class="rounded-circle border" width="65" height="65">
                <span class="position-absolute bottom-0 end-0 badge rounded-pill bg-secondary border border-white">Member</span>
            </div>
            <div class="ms-3">
                <h5 class="fw-bold mb-1">@kh.TenKH</h5>
                <div class="text-muted small mb-1">@kh.SDT</div>
                <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">
                    @(Model.LoaiKhachHang != null ? Model.LoaiKhachHang.TenLoai : "Thành viên mới")
                </span>
            </div>
        </div>

        <div class="d-flex text-center">
            <div class="px-4 border-end">
                <h5 class="fw-bold mb-0">@soDon</h5>
                <small class="text-muted">Đơn hàng</small>
            </div>
            <div class="px-4">
                <h5 class="fw-bold text-danger mb-0">@string.Format("{0:N0}đ", tongTien)</h5>
                <small class="text-muted">Tổng tiền tích lũy</small>
            </div>
        </div>
    </div>
</div>
@if (!Model.DangKyGoiTaps.Any()) { 
    
    <div class="alert alert-primary d-flex align-items-center justify-content-between border-0 shadow-sm mb-2" role="alert" style="background-color: #eef6fc;">
        <div>
            <i class="fas fa-info-circle text-primary me-2"></i>
            <span class="text-primary fw-bold">Đăng ký Gói Tập ngay để nhận ưu đãi đặc quyền!</span>
        </div>
        <a href="@Url.Action("GoiTap", "GoiTap")" class="btn btn-sm btn-link text-decoration-none fw-bold">Đăng ký ngay</a>
    </div>
}
@if (!Model.DiaChis.Any()) { 
    
<div class="alert alert-primary d-flex align-items-center justify-content-between border-0 shadow-sm mb-4" role="alert" style="background-color: #eef6fc;">
    <div>
        <i class="fas fa-map-marker-alt text-primary me-2"></i>
        <span class="text-primary fw-bold">Thêm địa chỉ để đặt đơn hàng nhanh hơn.</span>
    </div>
    <a href="@Url.Action("ThongTinTaiKhoan", "Member")" class="btn btn-sm btn-link text-decoration-none fw-bold">Thêm địa chỉ</a>
</div>
}
<div class="row">
    <div class="col-lg-8">
        <div class="bg-white rounded-3 shadow-sm p-3 h-100">
            <h6 class="fw-bold mb-3 text-uppercase">Đơn hàng & Gói tập gần đây</h6>

            @if (activePackages != null && activePackages.Any())
            {
                foreach (var pack in activePackages)
                {
                    int ngayCon = (pack.NgayKetThuc - DateTime.Now).Days;
                    <div class="card mb-3 border shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div class="d-flex">
                                    <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                        <i class="fas fa-dumbbell text-danger fa-2x"></i>
                                    </div>
                                    <div class="ms-3">
                                        <h6 class="fw-bold mb-1">Gói tập: @pack.GoiTap.TenGoi</h6>
                                        <p class="text-muted small mb-1">Hết hạn: @pack.NgayKetThuc.ToString("dd/MM/yyyy")</p>
                                        <span class="badge bg-success">Đang hoạt động</span>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold text-danger mb-2">Còn @ngayCon ngày</div>
                                    <a href="@Url.Action("CheckoutGoiTap", "GoiTap", new { id = pack.MaGoiTap })" class="btn btn-sm btn-outline-danger fw-bold">Gia hạn</a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }

            @if (recentOrders != null && recentOrders.Any())
            {
                foreach (var item in recentOrders.OrderByDescending(hd => hd.NgayLap))
                {
                    if (item.MaDonHang != null)
                    {
                        <a class="card mb-3 border-1 border px-2 py-0 text-decoration-none text-black" href="@Url.Action("ChiTietHoaDon", "Member", new {maHd = item.MaHD})">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center w-100 mb-2">
                                    <div class="d-flex align-items-center align-content-center">
                                        <span class="text-muted">Đơn hàng: </span>
                                        <span class="fw-bold ms-1">#@item.MaDonHang</span>
                                        <span class="text-muted fw-bolder fs-5 mx-2">•</span>
                                        <span class="text-muted">Ngày đặt hàng: <span class="fw-bold text-dark">@item.NgayLap.Value.ToString("dd/MM/yyyy")</span></span>
                                    </div>
                                    <div class="text-end">
                                        @if (@item.DonHang.TrangThaiDonHang == "Đã giao hàng")
                                        {
                                            <div class="text-success border border-1 rounded-2 p-1 fw-bold" style="background-color: #c9eed9; font-size: 12px">
                                                Đã nhận hàng
                                            </div>
                                        }
                                        @if (@item.DonHang.TrangThaiDonHang == "Chờ xác nhận")
                                        {
                                            <div class="text-secondary border border-1 rounded-2 p-1 fw-bold" style="background-color: #e9e4e4; font-size: 12px">
                                                @item.DonHang.TrangThaiDonHang
                                            </div>
                                        }
                                        @if (@item.DonHang.TrangThaiDonHang == "Chờ giao hàng")
                                        {
                                            <div class="text-warning border border-1 rounded-2 p-1 fw-bold" style="background-color: #faefb9; font-size: 12px">
                                                @item.DonHang.TrangThaiDonHang
                                            </div>
                                        }
                                        @if (@item.DonHang.TrangThaiDonHang == "Đã hủy")
                                        {
                                            <div class="text-danger border border-1 rounded-2 p-1 fw-bold" style="background-color: #f5aeae; font-size: 12px">
                                                @item.DonHang.TrangThaiDonHang
                                            </div>
                                        }
                                    </div>
                                </div>
                                @if (item.ChiTietHoaDons.Count > 1)
                                {

                                    var firstProduct = item.ChiTietHoaDons.FirstOrDefault()?.SanPham;
                                    var mainImage = firstProduct?.HINHANHs.FirstOrDefault(h => h.IsMain == true)?.Url ?? "logo.png";
                                    var imageUrl = Url.Content("~/Content/Images/" + mainImage);
                                    <div class="w-100 d-flex row">
                                        <div class="d-flex gap-2 mb-3 col-8">
                                            <img src="@imageUrl" style="width: 20%" alt="@firstProduct?.TenSP" />
                                            <div class="d-flex flex-column justify-content-center">
                                                <span class="fs-6 text-uppercase fw-bolder text-break" style="word-break: break-word;">
                                                    @firstProduct.TenSP
                                                </span>
                                                <span class="small fw-bolder">
                                                    @(firstProduct.GiaKhuyenMai != null && firstProduct.GiaKhuyenMai > 0 ? firstProduct.GiaKhuyenMai.Value.ToString("N0") + " đ": firstProduct.DonGia.ToString("N0") + " đ")
                                                </span>
                                                <span class="small">Cùng @(item.ChiTietHoaDons.Count - 1) sản phẩm khác</span>
                                            </div>
                                        </div>
                                        <div class="d-flex col-4 flex-column justify-content-center text-end p-0">
                                            <span class="fw-normal" style="font-size: 12px">Tổng thanh toán: <span class="fw-bold text-danger" style="font-size: 15px">@item.DonHang.TongTien.ToString("N0")đ</span></span>
                                            <span class="fw-bold" style="font-size: 13px">Xem chi tiết ></span>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    var firstProduct = item.ChiTietHoaDons.FirstOrDefault()?.SanPham;
                                    var mainImage = firstProduct?.HINHANHs.FirstOrDefault(h => h.IsMain == true)?.Url ?? "logo.png";
                                    var imageUrl = Url.Content("~/Content/Images/" + mainImage);
                                    <div class="w-100 d-flex row">
                                        <div class="d-flex gap-2 mb-3 col-8">
                                            <img src="@imageUrl" style="width: 20%" alt="@firstProduct?.TenSP" />
                                            <div class="d-flex flex-column justify-content-center">
                                                <span class="fs-6 text-uppercase fw-bolder text-break" style="word-break: break-word;">
                                                    @firstProduct.TenSP
                                                </span>
                                                <span class="small fw-bolder">
                                                    @(firstProduct.GiaKhuyenMai != null && firstProduct.GiaKhuyenMai > 0 ? firstProduct.GiaKhuyenMai.Value.ToString("N0") + " đ": firstProduct.DonGia.ToString("N0") + " đ")
                                                </span>                                                
                                            </div>
                                        </div>
                                        <div class="d-flex col-4 flex-column justify-content-center text-end p-0">
                                            <span class="fw-normal" style="font-size: 12px">Tổng thanh toán: <span class="fw-bold text-danger" style="font-size: 15px">@item.DonHang.TongTien.ToString("N0")đ</span></span>
                                            <span class="fw-bold" style="font-size: 13px">Xem chi tiết ></span>
                                        </div>
                                    </div>
                                }
                            </div>

                        </a>
                    }
                    else
                    {
                        var firstDetail = item.ChiTietHoaDons.FirstOrDefault();
                        decimal gia = 0;
                        string tenHienThi = "";

                        <a class="card mb-3 border-1 border px-2 py-0 text-decoration-none text-black" href="@Url.Action("ChiTietHoaDon", "Member", new {maHd = item.MaHD})">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center w-100 mb-2">
                                    <div class="d-flex align-items-center align-content-center">
                                        <span class="text-muted">Hóa đơn: </span>
                                        <span class="fw-bold ms-1">#@item.MaHD</span>
                                        <span class="text-muted fw-bolder fs-5 mx-2">•</span>
                                        <span class="text-muted">Ngày đăng ký: <span class="fw-bold text-dark">@item.NgayLap.Value.ToString("dd/MM/yyyy")</span></span>
                                    </div>
                                    <div class="text-end">
                                        @if (@item.TrangThai == "Đã thanh toán")
                                        {
                                            <div class="text-success border border-1 rounded-2 p-1 fw-bold" style="background-color: #c9eed9; font-size: 12px">
                                                @item.TrangThai
                                            </div>
                                        }
                                        @if (@item.TrangThai == "Chưa thanh toán")
                                        {
                                           <div class="text-warning border border-1 rounded-2 p-1 fw-bold" style="background-color: #faefb9; font-size: 12px">
                                               @item.TrangThai
                                           </div>
                                        }
                                    </div>
                                </div>
                                    <div class="w-100 d-flex row p-0">
                                        <div class="d-flex gap-2 mb-3 col-8 p-0">
                                            <img src="@Url.Content("~/Content/Images/logo.png")" class="me-2 ms-2" style="width: 16%; filter: opacity(0.7);" />
                                            <div class="d-flex flex-column justify-content-center">

                                                    @if (firstDetail != null)
                                                    {
                                                        if (firstDetail.MaDKLop != null)
                                                        {
                                                            tenHienThi = "lớp " + firstDetail.DangKyLop.LopHoc.TenLop;
                                                            gia = firstDetail.DangKyLop.LopHoc.HocPhi;
                                                        }
                                                        else if (firstDetail.MaDKPT != null)
                                                        {
                                                            tenHienThi = "PT " + firstDetail.DangKyPT.NhanVien.TenNV;
                                                            gia = firstDetail.DangKyPT.GiaMoiBuoi * firstDetail.DangKyPT.SoBuoi;
                                                        }
                                                        else if (firstDetail.MaDKGT != null)
                                                        {
                                                            tenHienThi = "Gói tập " + firstDetail.DangKyGoiTap.GoiTap.TenGoi;
                                                            gia = firstDetail.DangKyGoiTap.GoiTap.Gia;
                                                        }
                                                    }
                                                
                                                <span class="fs-6 text-uppercase fw-bolder text-break" style="word-break: break-word;">
                                                    @tenHienThi
                                                </span>
                                                <span class="small fw-bolder">
                                                    @gia.ToString("N0")đ
                                                </span>                                                
                                            </div>
                                        </div>
                                        <div class="d-flex col-4 flex-column justify-content-center text-end p-0">
                                            <span class="fw-normal" style="font-size: 12px">Tổng thanh toán: <span class="fw-bold text-danger" style="font-size: 15px">@item.ThanhTien.Value.ToString("N0")đ</span></span>
                                            <span class="fw-bold" style="font-size: 13px">Xem chi tiết ></span>
                                        </div>
                                    </div>                                
                            </div>

                        </a>
                    }
                }
            }
            else if (activePackages == null || !activePackages.Any())
            {
                <div class="text-center py-4">
                    <p class="text-muted small">Bạn chưa có đơn hàng nào.</p>
                    <a href="@Url.Action("Index", "Home")" class="btn btn-danger btn-sm">Mua sắm ngay</a>
                </div>
            }
        </div>
    </div>

    <div class="col-lg-4">
        <div class="bg-white rounded-3 shadow-sm p-3 h-100">
            <h6 class="fw-bold mb-3 text-uppercase">Ưu đãi của bạn</h6>
            <div class="text-center py-5">
                <img src="~/Content/Images/logo.png" style="width: 80px; opacity: 0.5" class="mb-3">
                <p class="text-muted small">Hiện chưa có ưu đãi cá nhân nào.</p>
                <a href="@Url.Action("GoiTap", "GoiTap")" class="text-danger fw-bold text-decoration-none small">Xem các gói tập <i class="fas fa-arrow-right"></i></a>
            </div>
        </div>
    </div>
</div>