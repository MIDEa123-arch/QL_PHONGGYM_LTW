@model List<QL_PHONGGYM.Models.NhanVien>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white py-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0 fw-bold text-primary"><i class="fas fa-user-tie me-2"></i> Danh sách nhân viên</h5>
            <a href="@Url.Action("Create")" class="btn btn-primary btn-sm">
                <i class="fas fa-plus me-1"></i> Thêm nhân viên
            </a>
        </div>

        @* Cập nhật Form: Thêm maCM và thay đổi class cho phù hợp với 4 cột lọc *@
        @using (Html.BeginForm("Index", "AdminStaff", FormMethod.Get, new { @class = "row g-3" }))
        {
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text bg-light"><i class="fas fa-search"></i></span>
                    <input type="text" name="search" value="@ViewBag.CurrentSearch" class="form-control" placeholder="Tìm theo tên, SĐT hoặc tài khoản..." />
                </div>
            </div>
            <div class="col-md-3">
                @Html.DropDownList("MaChucVu", (SelectList)ViewBag.ListChucVu, "-- Tất cả chức vụ --", new { @class = "form-select" })
            </div>

            <div class="col-md-3">
                @* Thêm Dropdown Chuyên môn *@
                @Html.DropDownList("MaCM", (List<SelectListItem>)ViewBag.ListChuyenMon, new { @class = "form-select" })
            </div>

            <div class="col-md-2 d-flex">
                <button type="submit" class="btn btn-primary me-1"><i class="fas fa-filter me-1"></i> Lọc</button>
                <a href="@Url.Action("Index")" class="btn btn-outline-secondary" title="Tải lại / Xóa bộ lọc">
                    <i class="fas fa-sync-alt"></i>
                </a>
            </div>
        }
    </div>

    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">Họ tên</th>
                        <th>Chức vụ</th>
                        <th>Chuyên môn</th> @* Thêm cột Chuyên môn *@
                        <th>Liên hệ</th>
                        <th>Tài khoản</th>
                        <th>Trạng thái</th>
                        <th class="text-end pe-4">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-bold">@item.TenNV</div>
                                    <small class="text-muted">
                                        @item.GioiTinh
                                        @if (item.NgaySinh.HasValue)
                                        {
                                            <span> - @item.NgaySinh.Value.ToString("dd/MM/yyyy")</span>
                                        }
                                    </small>
                                </td>
                                <td>
                                    @if (item.ChucVu != null)
                                    {
                                        string badgeClass = item.ChucVu.TenChucVu.Contains("Quản lý") ? "bg-danger" :
                                                            (item.ChucVu.TenChucVu == "PT" ? "bg-warning text-dark" : "bg-info text-dark");
                                        <span class="badge @badgeClass">@item.ChucVu.TenChucVu</span>
                                    }
                                </td>
                                <td>
                                    @if (item.ChuyenMons != null && item.ChuyenMons.Any())
                                    {
                                        // Hiển thị danh sách chuyên môn (Boxing, Yoga,...)
                                        string cmList = string.Join(", ", item.ChuyenMons.Select(cm => cm.TenChuyenMon));
                                        <span class="small text-success">@cmList</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Không có</span>
                                    }
                                </td>
                                <td>
                                    <div class="small"><i class="fas fa-phone me-1 text-muted"></i> @item.SDT</div>
                                </td>
                                <td class="fw-bold text-primary">@item.TenDangNhap</td>

                                <td>
                                    @if (item.TrangThaiTaiKhoan == 1 || item.TrangThaiTaiKhoan == null)
                                    {
                                        <span class="badge bg-success">Đang làm việc</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Đã nghỉ việc</span>
                                    }
                                </td>

                                <td class="text-end pe-4">
                                    <a href="@Url.Action("Edit", new { id = item.MaNV })" class="btn btn-outline-primary btn-sm me-1" title="Sửa">
                                        <i class="fas fa-user-edit"></i>
                                    </a>

                                    @if (item.TrangThaiTaiKhoan == 1 || item.TrangThaiTaiKhoan == null)
                                    {
                                        <button onclick="confirmToggle(@item.MaNV, 'Khóa', 'danger')" class="btn btn-outline-danger btn-sm" title="Khóa/Cho nghỉ">
                                            <i class="fas fa-lock"></i> Khóa
                                        </button>
                                    }
                                    else
                                    {
                                        <button onclick="confirmToggle(@item.MaNV, 'Mở', 'success')" class="btn btn-outline-success btn-sm" title="Mở khóa">
                                            <i class="fas fa-lock-open"></i> Mở
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="7" class="text-center py-4 text-muted">Không tìm thấy nhân viên nào phù hợp với điều kiện lọc.</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    @if (ViewBag.TotalPages > 1)
    {
        <div class="card-footer bg-white py-3">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0">
                    @if (ViewBag.CurrentPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("Index", new { page = ViewBag.CurrentPage - 1, search = ViewBag.CurrentSearch, maChucVu = ViewBag.CurrentMaChucVu, maCM = ViewBag.CurrentMaCM })">Trước</a>
                        </li>
                    }

                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                    {
                        <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { page = i, search = ViewBag.CurrentSearch, maChucVu = ViewBag.CurrentMaChucVu, maCM = ViewBag.CurrentMaCM })">@i</a>
                        </li>
                    }

                    @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                    {
                        <li class="page-item">
                            <a class="page-link" href="@Url.Action("Index", new { page = ViewBag.CurrentPage + 1, search = ViewBag.CurrentSearch, maChucVu = ViewBag.CurrentMaChucVu, maCM = ViewBag.CurrentMaCM })">Sau</a>
                        </li>
                    }
                </ul>
            </nav>
        </div>
    }
</div>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        function confirmToggle(id, action, color) {
            if (confirm(`Bạn có chắc chắn muốn ${action} tài khoản nhân viên này không?`)) {

                var btn = event.target;
                if (btn.tagName === 'I') btn = btn.parentElement;

                var oldHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
                btn.disabled = true;

                $.ajax({
                    url: '@Url.Action("ToggleAccountStatus", "AdminStaff")',
                    type: 'POST',
                    data: { id: id },
                    success: function (res) {
                        btn.innerHTML = oldHtml;
                        btn.disabled = false;

                        if (res.success) {
                            alert(res.message);
                            // Tải lại trang hiện tại sau khi cập nhật trạng thái
                            window.location.reload(true);
                        } else {
                            alert(res.message);
                        }
                    },
                    error: function (xhr) {
                        btn.innerHTML = oldHtml;
                        btn.disabled = false;
                        console.log(xhr);
                        alert("Lỗi kết nối! (Mã lỗi: " + xhr.status + "). Vui lòng thử lại.");
                    }
                });
            }
        }

        // Tự động gửi form khi thay đổi dropdown Chức vụ hoặc Chuyên môn
        $(document).ready(function() {
            $('#MaChucVu, #MaCM').change(function() {
                // Đặt lại trang về 1 khi lọc
                $('input[name="page"]').val(1);
                $(this).closest('form').submit();
            });
        });
    </script>
}