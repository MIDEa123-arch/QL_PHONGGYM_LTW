@model QL_PHONGGYM.Models.LopHoc
@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
<div class="card border-0 shadow-sm" style="max-width: 900px; margin: 0 auto;">
    <div class="card-header bg-white py-3">
        <h5 class="mb-0 fw-bold text-primary">Tạo lớp học mới</h5>
    </div>
    <div class="card-body">
        @using (Html.BeginForm())
        {
            @Html.AntiForgeryToken()

            if (ViewBag.Error != null)
            {
                <div class="alert alert-danger">@ViewBag.Error</div>
            }
            @Html.ValidationSummary(true, "Vui lòng kiểm tra các lỗi sau:", new { @class = "alert alert-danger mb-3" }) @Html.ValidationSummary(true, "", new { @class = "text-danger mb-3" })

            <div class="row g-3">
                <div class="col-md-12">
                    <label class="form-label fw-bold">Tên lớp học <span class="text-danger">*</span></label>
                    @Html.TextBoxFor(m => m.TenLop, new { @class = "form-control", required = "required", placeholder = "Ví dụ: Yoga Sáng T2-T4-T6" })
                    @Html.ValidationMessageFor(m => m.TenLop, "", new { @class = "text-danger" })
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Bộ môn <span class="text-danger">*</span></label>
                    @Html.DropDownList("MaCM", null, "-- Chọn bộ môn --", new { @class = "form-select", required = "required", id = "ddlMaCM" })
                    @Html.ValidationMessageFor(m => m.MaCM, "", new { @class = "text-danger" })
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Huấn luyện viên phụ trách</label>
                    <select name="MaNV" id="ddlMaNV" class="form-select">
                        <option value="">-- Vui lòng chọn bộ môn trước --</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Ngày bắt đầu <span class="text-danger">*</span></label>
                    @Html.TextBoxFor(m => m.NgayBatDau, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date", required = "required" })
                    @Html.ValidationMessageFor(m => m.NgayBatDau, "", new { @class = "text-danger" })
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Ngày kết thúc <span class="text-danger">*</span></label>
                    @Html.TextBoxFor(m => m.NgayKetThuc, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date", required = "required" })
                    @Html.ValidationMessageFor(m => m.NgayKetThuc, "", new { @class = "text-danger" })
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Học phí (VNĐ) <span class="text-danger">*</span></label>

                    <input type="text"
                           name="strHocPhi"
                           id="txtHocPhi"
                           class="form-control currency-input"
                           required
                           placeholder="0"
                           value="@(Model.HocPhi > 0 ? Model.HocPhi.ToString("#,##0").Replace(",",".") : "")" />

                    @Html.ValidationMessageFor(m => m.HocPhi, "", new { @class = "text-danger" })
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-bold">Số buổi học <span class="text-danger">*</span></label>

                    @Html.TextBoxFor(m => m.SoBuoi, new
                    {
                        @class = "form-control",
                        type = "number",
                        required = "required",
                        min = "1",
                        placeholder = "Nhập tổng số buổi"
                    })

                    @Html.ValidationMessageFor(m => m.SoBuoi, "", new { @class = "text-danger" })
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Sĩ số tối đa <span class="text-danger">*</span></label>

                    @Html.TextBoxFor(m => m.SiSoToiDa, new
                    {
                        @class = "form-control",
                        type = "number",
                        required = "required",
                        min = "1",
                        Value = "30"
                    })

                    @Html.ValidationMessageFor(m => m.SiSoToiDa, "", new { @class = "text-danger" })
                </div>
            </div>
            <div class="col-md-12">
                <div class="card bg-light border-0">
                    <div class="card-body">
                        <h6 class="fw-bold text-primary mb-3">Cấu hình lịch học & Kiểm tra trùng HLV</h6>

                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Giờ Bắt Đầu</label>
                                <div class="d-flex gap-1">
                                    <select class="form-select form-select-sm" id="ddlGioBD" name="GioBatDauHour">
                                        @for (int h = 0; h < 24; h++)
                                        {
                                            <option value="@h.ToString("00")">@h.ToString("00") giờ</option>
                                        }
                                    </select>
                                    <select class="form-select form-select-sm" id="ddlPhutBD" name="GioBatDauMinute">
                                        <option value="00">00 phút</option>
                                        <option value="15">15 phút</option>
                                        <option value="30">30 phút</option>
                                        <option value="45">45 phút</option>
                                    </select>
                                </div>
                                @Html.ValidationMessage("GioBatDau", new { @class = "text-danger small mt-1" }) 
                            </div>

                            <div class="col-md-3">
                                <label class="form-label fw-bold">Giờ Kết Thúc</label>
                                <div class="d-flex gap-1">
                                    <select class="form-select form-select-sm" id="ddlGioKT" name="GioKetThucHour">
                                        @for (int h = 0; h < 24; h++)
                                        {
                                            <option value="@h.ToString("00")">@h.ToString("00") giờ</option>
                                        }
                                    </select>
                                    <select class="form-select form-select-sm" id="ddlPhutKT" name="GioKetThucMinute">
                                        <option value="00">00 phút</option>
                                        <option value="15">15 phút</option>
                                        <option value="30">30 phút</option>
                                        <option value="45">45 phút</option>
                                    </select>
                                </div>
                                @Html.ValidationMessage("GioKetThuc", new { @class = "text-danger small mt-1" })
                            </div>

                            <div class="col-md-12">
                                <label class="form-label fw-bold d-block">Chọn ngày học trong tuần: <span class="text-danger">*</span></label>
                                <div class="btn-group" role="group">
                                    <input type="checkbox" class="btn-check" name="SelectedDays" value="1" id="Mon" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="Mon">Thứ 2</label>

                                    <input type="checkbox" class="btn-check" name="SelectedDays" value="2" id="Tue" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="Tue">Thứ 3</label>

                                    <input type="checkbox" class="btn-check" name="SelectedDays" value="3" id="Wed" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="Wed">Thứ 4</label>

                                    <input type="checkbox" class="btn-check" name="SelectedDays" value="4" id="Thu" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="Thu">Thứ 5</label>

                                    <input type="checkbox" class="btn-check" name="SelectedDays" value="5" id="Fri" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="Fri">Thứ 6</label>

                                    <input type="checkbox" class="btn-check" name="SelectedDays" value="6" id="Sat" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="Sat">Thứ 7</label>

                                    <input type="checkbox" class="btn-check" name="SelectedDays" value="0" id="Sun" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="Sun">CN</label>
                                </div>
                                <div class="text-danger small mt-1">
                                    @Html.ValidationMessage("SelectedDays")
                                </div>
                                <div class="form-text small mt-1">Chọn ít nhất một ngày. Hệ thống sẽ tự động tạo lịch dựa trên các thứ đã chọn.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 text-end">
                <a href="@Url.Action("Index")" class="btn btn-light border me-2">Hủy</a>
                <button type="submit" class="btn btn-primary px-4 fw-bold">Tạo lớp</button>
            </div>
        }
    </div>
</div>

@section scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Định nghĩa các biến mới (Lấy từ ID của các dropdown giờ/phút)
            const ddlMaCM = document.getElementById('ddlMaCM');
            const ddlMaNV = document.getElementById('ddlMaNV');
            const inpNgayBD = document.querySelector('input[name="NgayBatDau"]');
            const inpNgayKT = document.querySelector('input[name="NgayKetThuc"]');

            const ddlGioBD = document.getElementById('ddlGioBD');
            const ddlPhutBD = document.getElementById('ddlPhutBD');
            const ddlGioKT = document.getElementById('ddlGioKT');
            const ddlPhutKT = document.getElementById('ddlPhutKT');

            const checkboxes = document.querySelectorAll('input[name="SelectedDays"]');
            const currencyInputs = document.querySelectorAll('.currency-input');

            // --- HÀM TÍNH PHÚT VÀ KIỂM TRA LOGIC (FIXED) ---
            function checkTimeDifference() {
                // Lấy giá trị giờ và phút (luôn có giá trị vì là dropdown)
                const gioBD = parseInt(ddlGioBD.value);
                const phutBD = parseInt(ddlPhutBD.value);
                const gioKT = parseInt(ddlGioKT.value);
                const phutKT = parseInt(ddlPhutKT.value);

                // Chuyển thành tổng số phút từ 00:00
                var startMinutes = gioBD * 60 + phutBD;
                var endMinutes = gioKT * 60 + phutKT;

                // 1. KIỂM TRA LOGIC CƠ BẢN (Giờ kết thúc > Giờ bắt đầu)
                if (endMinutes <= startMinutes) {
                    alert("Lỗi: Giờ kết thúc phải lớn hơn Giờ bắt đầu!");
                    // Không cho phép chạy tiếp
                    return;
                }

                // 2. KIỂM TRA THỜI LƯỢNG TỐI THIỂU (30 phút)
                if (endMinutes - startMinutes < 30) {
                    alert("Lỗi: Thời lượng buổi học phải ít nhất 30 phút!");
                    return;
                }

                // 3. Nếu hợp lệ, tiến hành load HLV
                loadAvailableTrainers();
            }


            function loadAvailableTrainers() {
                const maCM = ddlMaCM.value;
                const ngayBD = inpNgayBD.value;
                const ngayKT = inpNgayKT.value;

                // Lấy giờ phút từ dropdown và ghép thành chuỗi HH:mm (QUAN TRỌNG CHO CONTROLLER)
                const gioBD_str = ddlGioBD.value + ":" + ddlPhutBD.value;
                const gioKT_str = ddlGioKT.value + ":" + ddlPhutKT.value;


                let selectedDays = [];
                checkboxes.forEach(cb => { if (cb.checked) selectedDays.push(cb.value); });

                ddlMaNV.innerHTML = '';

                if (maCM && ngayBD && ngayKT && selectedDays.length > 0) {
                    // (Giữ nguyên logic gọi API load Available Trainers)

                    let defaultOpt = document.createElement('option');
                    defaultOpt.text = "-- Đang kiểm tra lịch trống... --";
                    ddlMaNV.appendChild(defaultOpt);
                    ddlMaNV.disabled = true;

                    let query = `maCM=${maCM}&ngayBatDau=${ngayBD}&ngayKetThuc=${ngayKT}&gioBatDau=${gioBD_str}&gioKetThuc=${gioKT_str}`;
                    selectedDays.forEach(d => query += `&selectedDays=${d}`);

                    fetch('/AdminClass/GetAvailableTrainers?' + query)
                        .then(res => res.json())
                        .then(data => {
                            ddlMaNV.innerHTML = '';
                            ddlMaNV.disabled = false;

                            if (data.length > 0) {
                                let prompt = document.createElement('option');
                                prompt.value = "";
                                prompt.text = `-- Tìm thấy ${data.length} HLV rảnh --`;
                                ddlMaNV.appendChild(prompt);

                                data.forEach(item => {
                                    let opt = document.createElement('option');
                                    opt.value = item.MaNV;
                                    opt.text = item.TenNV;
                                    ddlMaNV.appendChild(opt);
                                });
                            } else {
                                let empty = document.createElement('option');
                                empty.text = "-- Tất cả HLV đều bận giờ này --";
                                ddlMaNV.appendChild(empty);
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            ddlMaNV.innerHTML = '<option>-- Lỗi tải dữ liệu --</option>';
                            ddlMaNV.disabled = false;
                        });
                }
                else if (maCM) {
                    // Nếu thiếu thông tin ngày giờ, chỉ load danh sách theo chuyên môn
                    ddlMaNV.innerHTML = '<option>-- Đang tải danh sách... --</option>';
                    fetch('/AdminClass/GetTrainersBySpecialty?maCM=' + maCM)
                        .then(res => res.json())
                        .then(data => {
                            // ... (Logic đổ HLV cơ bản) ...
                            ddlMaNV.innerHTML = '';
                            if (data.length > 0) {
                                let prompt = document.createElement('option');
                                prompt.value = "";
                                prompt.text = "-- Chọn HLV (Chưa check lịch) --";
                                ddlMaNV.appendChild(prompt);
                                data.forEach(item => {
                                    let opt = document.createElement('option');
                                    opt.value = item.MaNV;
                                    opt.text = item.TenNV;
                                    ddlMaNV.appendChild(opt);
                                });
                            } else {
                                ddlMaNV.innerHTML = '<option>-- Không có HLV dạy môn này --</option>';
                            }
                        });
                }
                else {
                    ddlMaNV.innerHTML = '<option value="">-- Vui lòng chọn bộ môn trước --</option>';
                }
            }


            // Hàm format tiền tệ (giữ nguyên)
            function formatCurrency(input) {
                var value = input.value.replace(/\D/g, "");
                if (value !== "") value = new Intl.NumberFormat('vi-VN').format(value);
                input.value = value;
            }

            // --- GÁN SỰ KIỆN (Cập nhật để lắng nghe 4 dropdown) ---
            if (ddlMaCM) {
                ddlMaCM.addEventListener('change', loadAvailableTrainers);
                inpNgayBD.addEventListener('change', loadAvailableTrainers);
                inpNgayKT.addEventListener('change', loadAvailableTrainers);
                checkboxes.forEach(cb => cb.addEventListener('change', loadAvailableTrainers));

                // Lắng nghe sự kiện của 4 dropdown giờ/phút
                ddlGioBD.addEventListener('change', checkTimeDifference);
                ddlPhutBD.addEventListener('change', checkTimeDifference);
                ddlGioKT.addEventListener('change', checkTimeDifference);
                ddlPhutKT.addEventListener('change', checkTimeDifference);
            }

            currencyInputs.forEach(input => {
                input.addEventListener('input', function () { formatCurrency(this); });
                formatCurrency(input);
            });
        });
    </script>
}