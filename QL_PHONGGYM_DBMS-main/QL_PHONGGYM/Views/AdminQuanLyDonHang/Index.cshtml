@model List<QL_PHONGGYM.Models.DonHang>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white py-3">
        <h5 class="mb-0 fw-bold text-primary"><i class="fas fa-box-open me-2"></i> Quản lý Đơn hàng</h5>
        <div class="row g-2 mt-3">
            <div class="col-md-4">
                <input type="text" id="txtSearch" class="form-control" value="@ViewBag.CurrentSearch" placeholder="Tìm mã đơn hoặc tên khách..." onkeyup="if(event.keyCode===13) FilterOrders(1)">
            </div>
            <div class="col-md-3">
                <select id="ddlStatus" class="form-select" onchange="FilterOrders(1)">
                    <option value="" @(ViewBag.CurrentStatus == "" ? "selected" : "")>-- Tất cả trạng thái --</option>
                    <option value="Chờ xác nhận" @(ViewBag.CurrentStatus == "Chờ xác nhận" ? "selected" : "")>Chờ xác nhận</option>
                    <option value="Chờ giao hàng" @(ViewBag.CurrentStatus == "Chờ giao hàng" ? "selected" : "")>Chờ giao hàng</option>
                    <option value="Đã giao hàng" @(ViewBag.CurrentStatus == "Đã giao hàng" ? "selected" : "")>Đã giao hàng</option>
                    <option value="Đã hủy" @(ViewBag.CurrentStatus == "Đã hủy" ? "selected" : "")>Đã hủy</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-primary w-100" onclick="FilterOrders(1)">Tìm kiếm</button>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div id="orderTableContainer">
            @Html.Partial("DanhSachDonHang", Model)
        </div>
    </div>

    @if (ViewBag.TotalPages > 1)
    {
        <div class="card-footer bg-white py-3">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0">
                    @if (ViewBag.CurrentPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="javascript:void(0)" onclick="FilterOrders(@(ViewBag.CurrentPage - 1))">Trước</a>
                        </li>
                    }

                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                    {
                        <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                            <a class="page-link" href="javascript:void(0)" onclick="FilterOrders(@i)">@i</a>
                        </li>
                    }

                    @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                    {
                        <li class="page-item">
                            <a class="page-link" href="javascript:void(0)" onclick="FilterOrders(@(ViewBag.CurrentPage + 1))">Sau</a>
                        </li>
                    }
                </ul>
            </nav>
        </div>
    }
</div>

<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết đơn hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalContent"></div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>

        function FilterOrders(page) {
            var search = $('#txtSearch').val();
            var status = $('#ddlStatus').val();

            if (!page) page = 1;

            $.ajax({
                url: '/AdminOrder/Index',
                type: 'GET',
                data: {
                    search: search,
                    status: status,
                    page: page, 
                    isAjax: true
                },
                success: function (res) {
                    $('#orderTableContainer').html(res);
                },
                error: function () {
                    alert("Lỗi tải dữ liệu!");
                }
            });
        }

        function updateOrderStatus(id, action, e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }

            var msg = "Bạn có chắc chắn muốn thực hiện hành động này?";
            if (action == 'cancel') msg = "CẢNH BÁO: Bạn có chắc muốn HỦY đơn hàng này không?";

            if (!confirm(msg)) return;

            var btn = e ? e.target : null;
            if (btn && btn.tagName === 'I') btn = btn.parentElement;

            var oldHtml = "";
            if (btn) {
                oldHtml = btn.innerHTML;
                btn.innerHTML = '...';
                btn.disabled = true;
            }

            $.ajax({
                url: '/AdminOrder/UpdateStatus', 
                type: 'POST',
                data: { id: id, status: (action == 'cancel' ? 'Hủy' : (action == 'ship' ? 'Đã giao hàng' : 'Chờ giao hàng')) },

                success: function (res) {
                    if (res.success) {
                        alert("Cập nhật thành công!");

                        var currentPage = $('.pagination .page-item.active .page-link').text();
                        FilterOrders(currentPage ? currentPage : 1);

                    } else {
                        alert("Lỗi: " + res.message);
                        if (btn) {
                            btn.innerHTML = oldHtml;
                            btn.disabled = false;
                        }
                    }
                },
                error: function () {
                    alert("Lỗi kết nối Server!");
                    if (btn) {
                        btn.innerHTML = oldHtml;
                        btn.disabled = false;
                    }
                }
            });
        }

        function viewOrder(id) {
            $('#modalContent').html('<div class="text-center py-4"><div class="spinner-border text-primary"></div><br>Đang tải dữ liệu...</div>');
            var myModal = new bootstrap.Modal(document.getElementById('orderModal'));
            myModal.show();

            $.ajax({
                url: '/AdminOrder/Details', 
                type: 'GET',
                data: { id: id },
                success: function (res) {
                    $('#modalContent').html(res);
                },
                error: function () {
                    $('#modalContent').html('<div class="text-danger text-center">Không thể tải chi tiết đơn hàng.</div>');
                }
            });
        }
    </script>
}